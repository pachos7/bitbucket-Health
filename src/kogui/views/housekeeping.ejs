<% include ./head %>
<body>
<% include ./header %>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.7.0/moment.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js" type="text/javascript"></script> 
<main role="main" class="col-sm-9 ml-sm-auto col-md-10 pt-3">
    <% if (typeof houseKeepingDaemonInfo === "undefined" || houseKeepingDaemonInfo === null) { %>
      <tr><td>No HouseKeeping Daemon Status Information Found</td></tr>
      <a href="/server/getHouseKeepingStatus">
        <button class="btn btn-dark ">Update HouseKeeping Status</button>
      </a>
    <% } else {  %>
        <div class="card" style="width: 40rem;">
          <div class="card-header">
          <i class="fa fa-table"></i> HouseKeeping Daemons Status as of <b><%= houseKeepingInfoDate %></b></div>
          <div class="card-body">
            <div class="table-responsive">
            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead class="thead-light">
           	     <tr align="center">
                   <%Object.keys(houseKeepingDaemonInfo[0]).forEach(function(thisCol){ %>
                    <th> <%=thisCol%> </th>
                   <%}); %>   
           	     </tr>
                </thead>
                
                <% houseKeepingDaemonInfo.forEach(function(thisDaemonObject) { %>
                  <tr align="center">
                    <% Object.keys(thisDaemonObject).forEach(function(thisCol){ %>
                      <%if (thisCol == "Type") { %>
                         <td><%= thisDaemonObject[thisCol] %></td>
                      <%} else {%>
                         <td> <% if (thisDaemonObject[thisCol] == 0) { %> <i class="fa fa-times-circle" style="color:#FF0000;"></i>
                          <% } else { %> <i class="fa fa-check-circle" style="color:#45c10b;"></i><% }  %> </td>
                      <% } %>
                    <%  });   %>
                </tr>
            	<% });%>
            </table>
            <a href="/server/getHouseKeepingStatus">
                 <button class="btn btn-dark ">Update HouseKeeping Status</button>
            </a>
            </div>
          </div>
        </div>
    <% } %>
        <p></p>
    <% if (typeof houseKeepingOperationsInfo === "undefined" || houseKeepingOperationsInfo === null) { %>
      <tr><td>No HouseKeeping Operations Information Found</td></tr>
    <% } else {  
      var operationsList = [];
      var databaseList = [];
      var Operations = [];

      houseKeepingOperationsInfo.forEach(function(thisOperation) {
        var thisOpObj = Operations.find(o => o.type == thisOperation.OPERATION);
        if (thisOpObj == undefined) {
          Operations.push({type:thisOperation.OPERATION, datasets:[{label:thisOperation.DATABASE, data:[{x: thisOperation.DATE, y:thisOperation.COUNT}]}]});
        } else {
          var thisOpObjDB = thisOpObj.datasets.find(oDB => oDB.label == thisOperation.DATABASE);
          if (thisOpObjDB == undefined) {
            thisOpObj.datasets.push({label:thisOperation.DATABASE, data:[{x: thisOperation.DATE, y:thisOperation.COUNT}]});
          } else {
            thisOpObjDB.data.push({x: thisOperation.DATE, y:thisOperation.COUNT});
          }
        }
      });
            
    %>
      <div class="card">
        <div class="card-body">
            <% Operations.forEach(function(thisOperation) { %>
              <canvas id="<%=thisOperation.type%>Chart" height="50"></canvas>
              <br><br><br>
            <%}); %>
        </div>
      </div>

      <script>
          <% Operations.forEach(function(thisOperation) { 
            var backgroundColors = ['#045EC2', '#ff6384', '#de63ff', '#84ff63',];
            var i = 0;%>
            var <%=thisOperation.type%>ctxOperations = document.getElementById("<%=thisOperation.type%>Chart").getContext('2d');  
            var <%=thisOperation.type%>OperationsChart = new Chart(<%=thisOperation.type%>ctxOperations, {
              type: 'scatter',
              data:{
                  datasets:[
                  <%thisOperation.datasets.forEach(function(thisDB){ %>
                     {
                       label:"<%=thisDB.label%>",borderColor: '<%=backgroundColors[i]%>', 
                       data:[
                         <%thisDB.data.forEach(function(thisDataPoint) {%>
                         {
                          <% var parts =thisDataPoint.x.split('-');%>
                           x:new Date(<%=parts[0]%>,<%=parts[1] - 1%>,<%=parts[2]%>),y:<%=thisDataPoint.y%>
                         },
                        <%}); %>
                      ]
                     },
                    <%i = i + 1; }); %>
                  ]
              },  
                options: {
                  title: {
                      display: true,
                      text: '<%=thisOperation.type%> Operations Pending'
                  },
                 scales: {
                     yAxes: [{
                         ticks: {
                             suggestedMin: 0
                         }
                     }],
                     xAxes: [{
                        type: 'time',
                        time: {
                            unit: 'day'
                        }
                     }]
                 }
              }
            });                 
          <% 
            }); %>
      </script>
    <% } %>
</main>
<% include ./footer %>
</body>
</html>